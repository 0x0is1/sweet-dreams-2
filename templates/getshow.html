<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Player</title>
        <link rel="stylesheet" href="https://cdn.plyr.io/1.8.2/plyr.css">
        <script src="https://cdn.plyr.io/1.8.2/plyr.js"></script>
        <script src="https://cdn.jsdelivr.net/hls.js/latest/hls.js"></script>
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/getshow.css') }}">
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/bvselect.css') }}">
        <script src = "{{ url_for('static',filename='javascript/bvselect.js') }}"></script>
    </head>

  <body>
      <div class="nav">
          <h1>SunGlasses</h1>
      </div>
      <span class="screen">
        <div class="side-pane">
            <select id="selectbox" onchange="selectChanged(this)">
                <option value="##" data-separator="true" selected>Select Season</option>
            </select>
            <script>
            const data = '{{ show_detail | tojson | safe }}'.replace(/\r\n/g, '')
            let list = JSON.parse(data);
                // setting season list
                list.forEach(data => {
                    let opt = document.getElementById("selectbox");
                    let opt_box = document.createElement("option");
                    opt_box.setAttribute("value", list.indexOf(data));
                    if (data.name.length < 1) {
                        opt_box.innerText = data.series.post_title;
                    }
                    else {
                        opt_box.innerText = data.name;
                    }
                    opt.appendChild(opt_box);
                    // console.log(data);
                });
                window.selectChanged = (elem) => {
                    let series_index = elem.value;
                    let container = document.getElementById("container");
                    container.innerHTML = null;
                    list[series_index].episodes.all.reverse().forEach(ep_data => {
                        let ep_container = document.createElement("div");
                        ep_container.className = "episode-container";
                        ep_container.setAttribute("onclick", `set_episode(${ep_data.id})`);
                        let ep_count_node = document.createElement("span");
                        ep_count_node.className = "ep-count";
                        ep_count_node.innerText = ep_data.metadata.number;
                        let name_node = document.createElement("span");
                        name_node.className = "ep-name";
                        name_node.innerText = ep_data.title;
                        ep_container.appendChild(ep_count_node);
                        ep_container.appendChild(name_node);
                        container.appendChild(ep_container);
                    });
                }

                // adding event listener to episode containers
                window.set_episode = (e_id) => {
                    function setPlayer(stream_url) {
                        var video = document.querySelector('#player');

                        if (Hls.isSupported()) {
                            var hls = new Hls();
                            hls.loadSource(stream_url);
                            hls.attachMedia(video);
                            hls.on(Hls.Events.MANIFEST_PARSED,function() {
                            video.play();
                            });
                        }
                    
                        plyr.setup(video);
                    }                        
                    
                    function resp(data){
                        let res = JSON.parse(data);

                        // embed internal players
                        let elem = document.getElementById("internal-players")
                        .getElementsByClassName("player-options")[0];
                        elem.innerHTML = null;
                        if(res.internal_stream_players.length > 0){
                            document.getElementsByTagName("video")[0].style.display = "block";
                            document.getElementById("internal-players").style.display = "block";
                            res.internal_stream_players.forEach(player => {
                                let option_node = document.createElement("span");
                                option_node.className = "option";
                                option_node.innerText = `${player.language} (${player.quality}) [${player.server}]`;
                                option_node.addEventListener("click", ev => setPlayer(player.url));
                                elem.appendChild(option_node);
                            });
                        }

                        // embed external players
                        elem = document.getElementById("external-players")
                        .getElementsByClassName("player-options")[0];
                        elem.innerHTML = null;
                        if(res.external_stream_players.length > 0){
                            document.getElementById("external-players").style.display = "block";
                            res.external_stream_players.forEach(player => {
                                let option_node = document.createElement("a");
                                option_node.className = "option";
                                option_node.setAttribute("href", player.url);
                                option_node.setAttribute("target", "_blank");
                                option_node.innerText = `${player.language} (${player.quality}) [${player.server}]`;
                                elem.appendChild(option_node);
                            });
                        }

                        // embed downloads
                        elem = document.getElementById("download-players")
                        .getElementsByClassName("player-options")[0];
                        elem.innerHTML = null;
                        if(res.download_players.length > 0){
                            document.getElementById("download-players").style.display = "block";
                            res.download_players.forEach(player => {
                                let option_node = document.createElement("a");
                                option_node.className = "option";
                                option_node.setAttribute("href", player.url);
                                option_node.setAttribute("target", "_blank");
                                option_node.innerText = `${player.language} (${player.quality}) [${player.server}]`;
                                elem.appendChild(option_node);
                            });
                        }

                    }
                    
                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState == XMLHttpRequest.DONE){
                            resp(xhr.responseText);
                        }
                    };
                    xhr.open("GET", `/fetchep?gep_id=${e_id}`, true);
                    xhr.send();
                }

            
            </script>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    let selector = new BVSelect({
                        selector: "#selectbox",
                        width: "90%",
                        searchbox: true,
                        offset: true,
                        placeholder: "Select Option",
                        search_placeholder: "Search...",
                        search_autofocus: true,
                        breakpoint: 450
                    });
                });
            </script>
            <div id="container"></div>
        </div>
        <div class="video-pane">
            <video preload="none" id="player" autoplay controls crossorigin></video>
            <div class="ep-details">
                <span class="players-container">
                    <div id="internal-players">
                        <h2>Internal Players</h2>
                        <div class="player-options"></div>
                    </div>
                    <div id="external-players">
                        <h2>External Players</h2>
                        <div class="player-options"></div>
                    </div>
                    <div id="download-players">
                        <h2>Downloads</h2>
                        <div class="player-options"></div>
                    </div>
                </span>
            </div>
        </div>
    </span>

  </body>
</html>